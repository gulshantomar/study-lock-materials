name: Sync Library to Database

on:
  push:
    paths:
      - "pdfs/**/*.pdf"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect changed PDF files
        id: files
        run: |
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          # Use tab delimiter (-F'\t') to properly handle filenames with spaces
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} \
            | grep '\.pdf$' \
            | awk -F'\t' '{ 
                status = "modified"; 
                if ($1 == "A") status = "added"; 
                if ($1 == "D") status = "removed"; 
                print "{\"status\":\"" status "\",\"path\":\"" $2 "\"}" 
              }' \
            | paste -sd "," - \
            >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Skip if no PDF changes
        if: steps.files.outputs.changes == ''
        run: echo "No PDF changes detected"

      - name: Verify APP_URL is set
        run: |
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "APP_URL secret is missing or empty"
            exit 1
          fi

      - name: Build payload
        run: |
          echo "{\"changes\":[${{ steps.files.outputs.changes }}]}" > payload.json

      - name: Send sync payload to backend
        if: steps.files.outputs.changes != ''
        run: |
          curl --fail --show-error --silent \
            -X POST "${{ secrets.APP_URL }}/api/github/sync" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.SYNC_API_KEY }}" \
            --data-binary @payload.json
